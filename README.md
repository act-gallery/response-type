# Response Type Demo App

This application demonstrate how to generate response in different content type using ActFramework including
- JSON
- XML
- YAML
- csv
- excel file types (xls, xlsx)

## Quick start

To start in dev mode:

```bash
cd /path/to/a/app
mvn clean compile exec:exec
```

To start in prod mode:

```bash
cd /path/to/a/app
mvn clean package
cd target/dist
unzip *.zip
./start
```

Once you started you can navigate browser to `http://localhost:5460`, there
 you should be able to see the home page of the application:
 
![image](https://user-images.githubusercontent.com/216930/65925088-ae94dd00-e432-11e9-9070-bd300d7a27f3.png)

## Inside the App

What this app trying to demonstrate is to show how to create an Excel sheet
 of a list of model entities, specifically in this demo, a list of employees.

### The Employee Model

```java
@Data
public class Employee {

    enum Grade {
        E06, E07, E08, E09, E10, E11
    }

    @Label("工号")
    public String id;

    @Label("名")
    public String firstName;

    @Label("姓")
    public String lastName;

    @Label("级别")
    public Grade grade;

}
```

Note:

1. There is a `@Label` annotation on top of properties of `Employee`, they
 will be used to render the column header of `csv` and excel files; **Note**
 that JSON, XML and YAML file does not favor `@Label` annotation.

2. In the app there is a [TestDataGenerator](https://github.com/act-gallery/excel/blob/master/src/main/java/demo/excel/TestDataGenerator.java#L36) 
class which is used to generate a random list of Employee records. 

### The Service

```java
@TemplateContext("/")
public class EmployeeService {

    @LoadCollection(TestDataGenerator.class)
    private List<Employee> employees;

    @GetAction("template")
    public List<Employee> template(ActionContext context) {
        // we need to manually set the download file name here
        // otherwise it will be default to `template.xxx`
        context.downloadFileName("employees");
        return employees;
    }

    @GetAction
    @PropertySpec(cli = "id as Id, firstName as First name, lastName as Last name, grade as Grade")
    @Command(value = "employees", help = "list all employees")
    public List<Employee> employees() {
        return employees;
    }

}
```

In this service there is an employee list injected with annotation
 `@LoadCollection`, which get fed with random employee list generated by
  `TestDataGenerator` class.
  
There are two request handler methods (endpoints) defined in the service class:

1. employees() - returns the employee list on `GET /` request
2. template() - returns the employee list on `GET /template` request

### Views

#### The HTML template

The HTML template `resources/rythm/employees.html` is used
to render response for request with `Accept=text/html` header, which is the
home page when we navigate browser to `http://localhost:5460`.

In the page we have 2 major parts:

1. A group of links
2. Employee list table

The employee table renders all employees in the `employees` list injected
 into `EmployeeService` instance
 
The links are for getting employee list in different data presentation:

* `/json` - get employee list in JSON data
* `/xml` - get employee list in XML data
* `/yaml` - get employee list in YAML data
* `/csv` - get employee list in CSV file
* `/xls` - get employee list in xls file
* `/xlsx` - get employee list in xlsx file
* `/template/xls` - get employee list in xls file - rendered with predefined
 template
* `/template/xlsx` - get employee list in xlsx file - rendered with
 predefined template
 
An immediate question one might ask is there is no request handlers defined
 for these URLs, how can we get the response sent to these endpoints?
 
The answer is they all direct to `GET /` endpoint with different `Accept
` header rewritten to the request.

If we open the `/resources/app.properties` file we can see the following
 configuration:
 
```properties
content_suffix.aware=true
```

This configuration tells ActFramework to treat `/{content-suffix}` as `Accept
` header written, thus when it received a request to `/json`, it rewrite the
 `Accept` header of incoming request to `application/json` and route to
  `/` endpoint, similar things happen for `xml`, `yaml`, `/csv`, `/xls` and 
  `/xlsx` URLs. 
 
#### The excel templates

There are two excel templates defined in `resources/excel/` folder:

* template.xls - for xls file generation
* template.xlsx - for xlsx file generation

Both of them are defined using [JXLS](http://jxls.sourceforge.net/) 
templating engine:

![image](https://user-images.githubusercontent.com/216930/65927178-eeac8d80-e43b-11e9-8cae-23552110dcd9.png)

These templates will be used to service request sent to `/template` an it
 could easily see the rendered excel file are different from request sent to
  `/` which is rendered directly into excel file without template.

The direct rendered excel file

![image](https://user-images.githubusercontent.com/216930/65926955-13eccc00-e43b-11e9-9dec-cd317d08befc.png)

The template rendered excel file

![image](https://user-images.githubusercontent.com/216930/65926980-3848a880-e43b-11e9-90fe-d7637a70a966.png)

## Summary

This demo app shows 

1. How to generate response in different content types
1. How to generate excel file directly
2. How to generate excel file via JXLS template
3. How to use `content_suffix.aware=true` to allow ActFramework overwrite
 `Accept` header of incoming request